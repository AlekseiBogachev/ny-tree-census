# Среда разработки

## Структура

Среда разработки перенесена в собственный Docker-контейнер на основе
[официального образа Python](https://hub.docker.com/_/python/) версии 3.11.

Основные структурные элементы среды разработки:

1. Python
2. Git
3. Poetry
4. DVC
5. Jupyter Notebook
6. Pre-commit
7. Другие пакеты Python.

Для работы DVC необходим настроенный Git. К счастью,
[официальный образ Python](https://hub.docker.com/_/python/) "из коробки"
содержит Git, поэтому самостоятельная установка Git для
взаимодействия с репозиторием не требуется, достаточно только настроить его,
задав email и имя пользователя.

Для полноценной работы с удалённым репозиторием на GitHub необходимо поместить в
файл `/.dev_env_pat` в корневом каталоге проекта
[PAT](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens).

В данном проекте DVC не использует внешнего хранилища данных и при необходимости
забирает исходные данные из первоисточника
[2015 Street Tree Census - Tree Data
](https://data.cityofnewyork.us/Environment/2015-Street-Tree-Census-Tree-Data/uvpi-gqnh/about_data).

Пользователь может получить доступ к среде разработки как через командную строку
контейнера, так и с помощью Jupyter Notebook.
Директория проекта копируется в контейнер со средой разработки при сборке его
образа в каталог `/dockeruser/ny_tree_census`. Подробнее в разделе
[Запуск](#запуск).

По сути, среда разработки состоит из двух docker-образов:

- базового образа, содержащего Python и все необходимые пакеты,
- образа со средой разработки, содержащего файлы из каталога проекта, ключи
  и настройки пользователя.

Такое решение продиктовано использованием self-hosted runner для GitHub Actions,
docker-образ и контейнер которого собирается из образа базового контейнера.
Для работы раннера нужны только пакеты из базового образа, а в каталоге проекта,
ключах и настройках пользователя нет необходимости - раннер забирает всё, что
нужно, из удалённого репозитория.

На иллюстрации ниже представлена структура среды разработки.

![Среда разработки](/docs/figures/dev_env_container.svg)

Среда разработки полностью изолирована от каталога проекта на локальной машине,
файлы проекта копируются в каталог `/dockeruser/ny_tree_census` образа среды
разработки, а их владелец заменяется на пользователя созданного при сборке
образа (по умолчанию `dockeruser`). По сравнению с
[bind moutns](https://docs.docker.com/storage/bind-mounts/),
такой подход позволяет обеспечить большую безопасность и до конца следовать идее
изоляции окружения разработки, а также избежать конфликтов репозитория Git в
локальном каталоге пользователя и репозитория в каталоге в контейнере со средой
разработки.

> [!IMPORTANT]
> Полная изоляция среды разработки приводит к тому, что взаимодействие с каталогом
> проекта внутри неё становится возможным только через командную строку её
> контейнера (в т.ч. с помощью SSH, если её настроить) и запускаемый сервер
> Jupyter Notebook. Таким образом, чтобы забрать новые изменения в проекте из
> контейнера среды разработки в свой локальный каталог, пользователь должен будет
> либо найти способ взаимодействия непосредственно с файловой системой контейнера,
> например через SSH, либо отправить коммит в удалённый репозиторий. Таким образом
> для полноценной работы в корневом каталоге проекта должен находиться
> [PAT](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)
> для взаимодействия с удалённым репозиторием GitHub.
> **Нужно иметь в виду, что
> [PAT](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)
> будет скопирован внутрь образа контейнера со средой разработки при сборке.**

> [!TIP]
> Для работы с файловой системой контейнера непосредственно из IDE можно
> использовать **VS Code** с расширением
> [Visual Studio Code Remote Development Extension Pack](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack).
> Подробные инструкции есть в официальной документации.

## Пользователи

Работа в контейнере Docker под учетной записью привилегированного
пользователя `root`, считается небезопасной и нежелательна, поэтому в
во время сборки образа создаётся непривилегированный пользователь по умолчанию
`dockeruser`, от имени которого выполняются все действия в контейнере со средой
разработки.

При сборке образа среды разработки, после копирования каталога проекта,
владелец данного каталога (внутри контейнера) и всех файлов рекурсивно
заменяется на непривилегированного пользователя (по умолчанию `dockeruser`).

## Сборка образа

### Сборка базового образа

Шаги сборки базового образа описаны в [Dockerfile](/Dockerfile), расположенном в
корневом каталоге репозитория. Можно выделить следующие этапы сборки:

1. Загрузка базового образа -
[официальный образ Python](https://hub.docker.com/_/python/)
1. Создание группы пользователей `dockeruser`.
1. Созадние пользователя `dockeruser` без прав администратора. Нужно иметь в
виду, что домашний каталогом пользователя `dockeruser` будет директория
`/dockeruser/`, где `dockeruser` - имя созданного пользователя, далее к этому
пути будет привязана установка менеджера зависимостей Poetry и каталог с
проектом.
1. Переключение пользователя на `dockeruser`. Далее все операции выполняются от
его имени.
1. Настройка параметров Git: `user.name` и `user.email`.
1. Установка Poetry.
1. Добавление Poetry в `Path`.
1. Настройка Poetry - установка параметра `installer.max-workers`.
1. Переключение рабочего каталога на `/dockeruser/ny_tree_census` - директорию с
проектом.
1. Копирование в `/dockeruser/ny_tree_census` файлов `poetry.lock` (если есть)
и `pyproject.toml` из корневого каталога репозитория.
1. Установка зависимостей из `poetry.lock` (если есть) или `pyproject.toml`
(если отсутствует `poetry.lock`)без модуля с исходниками проекта (`src`).
1. Командой, исполняемой по умолчанию при запуске контейнера устанавливается
`/bin/bash`, чтобы пользователь мог сразу же получить доступ к командной строке.

[Dockerfile](/Dockerfile) параметризован. Ниже перечислены его параметры.
| Параметр | Описание                                                                                              | Значение по умолчанию          |
|----------|-------------------------------------------------------------------------------------------------------|--------------------------------|
| UNAME    | Имя пользователя, от имени которого будут выполняться действия в контейнере.                          | dockeruser                     |
| UID      | ID пользователя, указанного в UNAME.                                                                  | 1001                           |
| GID      | ID группы пользователя, указанного в UNAME.                                                           | 1001                           |
| GITUSER  | Имя пользователя, от которого будут совершаться комиты (значение параметра Git `user.name`).          | "Aleksei Bogachev"             |
| GITEMAIL | Email пользователя, от имени которого будут совершаться комиты (значение параметра Git `user.email`). | "bogachev.aleksey.m@gmail.com" |

Базовый образ получает тег `ny_tree_census_base`.

### Сборка образа среды разработки

Шаги сборки образа локальной среды разработки, описанные в
[Dockerfile_dev_env](/Dockerfile_dev_env), расположенном в корневом каталоге
репозитория. Можно выделить следующие этапы сборки:

1. Поиск и загрузка ранее собранного базового образа `ny_tree_census_base` в
   локальном регистре.
1. Переключение на учётную запись привилегированного пользователя `root`.
1. Копирование корневого каталога репозитория.
1. Рекурсивная смена владельца скопированного каталога.
1. Переключение на непривилегированного пользователя (по умолчанию `dockeruser`).
1. Установка рабочим каталогом `/dockeruser/ny_tree_census`.
1. Установка недостающих модулей с помощью Poetry - установка `src` 
   (модуля с исходниками проекта).
1. Установка [PAT](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)
1. Установка pre-commit hooks
1. Командой, исполняемой по умолчанию при запуске контейнера устанавливается
`/bin/bash`, чтобы пользователь мог сразу же получить доступ к командной строке.

[Dockerfile_dev_env](/Dockerfile_dev_env) параметризован. Ниже перечислены его параметры.
| Параметр | Описание                                                                                              | Значение по умолчанию          |
|----------|-------------------------------------------------------------------------------------------------------|--------------------------------|
| UNAME    | Имя пользователя, от имени которого будут выполняться действия в контейнере.                          | dockeruser                     |
| UID      | ID пользователя, указанного в UNAME.                                                                  | 1001                           |
| GID      | ID группы пользователя, указанного в UNAME.                                                           | 1001                           |
| REPO     | Имя удалённого репозитория GitHub в формате `имя_пользователя/название_репозитория.git` | `AlekseiBogachev/ny-tree-census.git` |

Образ локальной среды разработки получает тег `ny_tree_census_dev`.

## Запуск

### Запуск сборки

Прежде чем запускать среду разработки (контейнер с ней) или создавать
[self-hosted runner для GitHub Actions](https://docs.github.com/en/actions/hosting-your-own-runners),
необходимо собрать базовый образ и образ контейнера среды разработки. Для этого
в корне репозитория расположен скрипт [build.sh](/build.sh), который задаёт
параметры образа, настраивает логирование процесса сборки в файл
`/logs/docker_build.log` и собирает, сначала, базовый образ, затем, образ со
средой разработки.

[build.sh](/build.sh) задаёт следующие значения параметров для образа:

- `GITUSER="$(git config user.name)"` - параметру `GITUSER` присваивается
значение параметра `user.name` из настроек Git для текущего пользователя;
- `GITEMAIL="$(git config user.email)"` - параметру `GITEMAIL` присваивается
значение параметра `user.email` из настроек Git для текущего пользователя.
- `REPO="AlekseiBogachev/ny-tree-census.git"` - имя удалённого
  репозитория GitHub в формате `имя_пользователя/название_репозитория.git`

Скрипт [build.sh](/build.sh) нужно вызывать из корневого каталога репозитория
следующей командой:

```shell
user@user-pc:~/Project$ ./build.sh
```

После завершения сборки образов можно запустить среду разработки. Есть два варианта запуска среды разработки:

1. Запуск командной строки - скрипт [start.sh](/start.sh).
2. Запуск Jupyter Notebook - скрипт [jupyter.sh](/jupyter.sh).

### Start.sh

Скрипт выполняет следующие шаги:

1. Собирает образы, вызвав скрипт [build.sh](/build.sh).
2. Запускает контейнер с локальной средой разработки в интерактивном режиме.
3. Запускает Bash в контейнере и передаёт управление пользователю.
4. После выхода пользователя из консоли, удаляет контейнер.

Скрипт [start.sh](/start.sh) нужно запускать из корневого каталога репозитория
следующей командой:

```shell
user@user-pc:~/Project$ ./start.sh
```

Также можно запустить скрипт [start.sh](/start.sh) и сразу же передать в
контейнер команду для исполнения. В таком случае, нужно передать команду как
аргумент скрипта:

```shell
user@user-pc:~/Project$ ./start.sh <команда пользователя>
```

например,

```shell
user@user-pc:~/Project$ ./start.sh poetry run dvc repro
```

В этом случае контейнер, не будет возвращать управление пользователю, а сразу
выполнит переданную команду и завершит свою работу, после чего будет удалён.

### Jupyter.sh

Скрипт [jupyter.sh](/jupyter.sh) делает всё то же самое, что и
[start.sh](/start.sh), но вместо запуска Bash и передачи управления пользователю
он запускает сервер Jupyter Notebook на порте `8080`.
В [jupyter.sh](/jupyter.sh) нельзя передать команду как в [start.sh](/start.sh).

Скрипт [jupyter.sh](/jupyter.sh) нужно запускать из корневого каталога
репозитория следующей командой:

```shell
user@user-pc:~/Project$ ./jupyter.sh
```

После того как запустится сервер Jupyter Notebook, в командной строке
будет выведена ссылка с токеном, которую нужно будет скопировать в адресную
строку браузера и перейти по ней. После этого можно будет работать с Jupyter
Notebook как обычно. На рисунке ниже приведён пример вывода в командной строке
с выделенной ссылкой.

![Ссылка Jupyter Notebook](/docs/figures/jupyter_cmd_out_example.png)
